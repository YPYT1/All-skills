# Context Restore Skill - 完整使用指南

> **上下文恢复技能** - 当用户需要从中断处继续对话时使用

---

## 目录

1. [快速开始](#快速开始)
2. [用户场景示例](#用户场景示例)
3. [响应格式详解](#响应格式详解)
4. [CLI 使用方法](#cli-使用方法)
5. [JSON 数据格式](#json-数据格式)
6. [与其他技能的集成](#与其他技能的集成)
7. [最佳实践](#最佳实践)
8. [常见问题解答](#常见问题解答)
9. [故障排除](#故障排除)

---

## 快速开始

### 5 分钟入门

**步骤 1：了解触发条件**

当用户说出以下关键词时，技能自动触发：

| 语言 | 触发词 |
|------|--------|
| 中文 | "恢复上下文"、"恢复"、"接着"、"继续之前的工作"、"继续"、"之前聊到哪了" |
| 英文 | "restore context"、"continue"、"resume"、"what was I doing"、"where did we leave off" |

**步骤 2：选择恢复级别**

```
# 默认（推荐）
用户: "恢复上下文"
输出: normal 级别 - 项目状态 + 待办任务

# 简短确认
用户: "恢复上下文 -简短"
输出: minimal 级别 - 一句话摘要

# 详细恢复
用户: "恢复上下文 -完整"
输出: detailed 级别 - 完整历史记录
```

**步骤 3：等待用户确认**

技能发送恢复报告后，等待用户选择下一步操作。

---

### 最小示例

**用户输入：**
```
接着之前的工作
```

**技能响应：**
```
✅ 上下文已恢复

**当前任务：** 编写 API 文档
**最近操作：** 完成用户认证模块
**项目状态：** Backend-API-v2（开发中，75%）

需要继续哪个任务？
```

---

## 用户场景示例

### 场景 1：日常恢复（最常见）

**场景描述：** 用户离开一段时间（几小时）后回来，继续之前的工作。这是最高频的使用场景。

**用户输入：**
```
继续之前的工作
```

**技能执行流程：**
```
1. 读取 ./compressed_context/latest_compressed.json
2. 解析最近操作记录
3. 提取当前进行中的任务
4. 生成 normal 级别报告
```

**技能响应：**
```
✅ **上下文已恢复**

📋 当前任务
- 任务：编写 API 文档
- 优先级：高
- 状态：进行中（60%）

🔧 核心项目
- 项目名：Backend-API-v2
- 状态：开发中
- 完成度：75%

📝 最近操作记录
1. 完成用户认证模块（2小时前）
2. 修复登录漏洞（5小时前）
3. 编写单元测试（昨天）
4. 优化数据库查询（前天）
5. 添加日志记录（3天前）

💡 建议操作
→ 继续编写 API 端点文档
→ 先完成用户认证模块测试
→ 讨论下一个功能需求

您想继续哪个任务？或者我说得更详细一些。
```

**适用情况：**
- ✅ 用户离开几小时后回来
- ✅ 用户从其他任务切换回来
- ✅ 定期工作会话恢复

---

### 场景 2：长时间中断后恢复

**场景描述：** 用户离开较长时间（一天或更久），需要完整恢复上下文以重新进入工作状态。

**用户输入：**
```
恢复上下文 -完整
```

**技能执行流程：**
```
1. 读取 ./compressed_context/latest_compressed.json
2. 加载完整历史记录
3. 解析 MEMORY.md 内容
4. 生成 detailed 级别报告（带时间线）
```

**技能响应：**
```
✅ **上下文已恢复 - 详细模式**

═══════════════════════════════════════════════════════════
📅 会话信息
═══════════════════════════════════════════════════════════
- 会话ID: agent:main:main
- 开始时间: 2026-02-05 10:00 UTC
- 最后活跃: 2026-02-06 23:30 UTC
- 会话持续: 1天13小时
- 会话类型: 主会话

═══════════════════════════════════════════════════════════
📋 当前任务详情
═══════════════════════════════════════════════════════════
任务名称: 编写 API 文档
优先级: 🔥 高
截止日期: 2026-02-10
状态: 进行中（60%）
预计剩余: 4小时

任务描述:
为 Backend-API-v2 项目编写完整的 REST API 文档，
包括认证、用户管理、数据查询等模块。

关联文件:
- /workspace/backend-api/docs/openapi.yaml
- /workspace/backend-api/src/auth/

═══════════════════════════════════════════════════════════
🔧 核心项目状态
═══════════════════════════════════════════════════════════

1. 🏛️ Backend-API-v2
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   状态: 🔄 开发中
   优先级: 🔥 高
   完成度: 75%
   负责人: main agent
   
   子任务进度:
   ├── ✅ 用户认证模块（100%）
   ├── 🔄 API 文档编写（60%）
   ├── ⏳ 数据查询模块（40%）
   └── ⏳ 待开发功能（0%）
   
   最近操作:
   ├── ✅ 完成用户认证模块（2026-02-06 21:00）
   ├── ✅ 修复登录漏洞（2026-02-06 18:00）
   ├── 🔄 编写单元测试（2026-02-05 16:00）
   └── 📝 优化数据库查询（2026-02-05 10:00）

2. 🌐 Frontend-Dashboard-v3
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   状态: ⚠️ 待测试
   优先级: 🔸 中
   完成度: 90%
   
   最近操作:
   ├── ✅ UI 组件完成（2026-02-04）
   └── ⚠️ 集成测试未通过（2026-02-03）

═══════════════════════════════════════════════════════════
📝 MEMORY.md 要点
═══════════════════════════════════════════════════════════
• 用户偏好：详细的技术文档，使用 Markdown 格式
• 工作习惯：每天早上 9:00 开始工作，先处理高优先级任务
• 技术栈：Python > Node.js > Go
• 当前目标：本周完成 Backend-API-v2 的 API 文档
• 沟通风格：简洁明了，直接给出选项

═══════════════════════════════════════════════════════════
🕐 完整时间线
═══════════════════════════════════════════════════════════
2026-02-06 23:30  → 用户离开，最后活跃
2026-02-06 21:00  → 完成用户认证模块
2026-02-06 18:00  → 修复登录漏洞（CVE-2026-001）
2026-02-06 14:00  → 开始 API 文档编写
2026-02-05 16:00  → 编写用户认证单元测试
2026-02-05 10:00  → 优化数据库查询性能
2026-02-04 20:00  → Frontend UI 组件完成
2026-02-04 14:00  → 开始 Backend-API-v2 开发

═══════════════════════════════════════════════════════════
💡 建议操作
═══════════════════════════════════════════════════════════
1. 🔴 高优先级：完成 API 文档（截止日期: 2026-02-10）
2. 🟡 中优先级：修复 Frontend 集成测试问题
3. 🟢 低优先级：规划下一个迭代功能

═══════════════════════════════════════════════════════════
🎯 下一步行动
═══════════════════════════════════════════════════════════
您可以：
1. 输入 "继续 API 文档" → 继续当前任务
2. 输入 "查看测试报告" → 查看 Frontend 测试详情
3. 输入 "新任务" → 开始讨论新功能
4. 输入 "详细" → 获取更多上下文信息

请告诉我您想怎么做？
```

**适用情况：**
- ✅ 用户离开一天或更长时间
- ✅ 新一天工作开始需要回顾
- ✅ 设备切换后的上下文恢复
- ✅ 重要会议前的上下文准备

---

### 场景 3：快速确认模式

**场景描述：** 用户只需要快速确认当前状态，不需要详细信息。适用于移动端或快速交互场景。

**用户输入：**
```
接着 -简短
```

**或者：**
```
恢复上下文 minimal
```

**技能响应：**
```
✅ 已恢复 → 编写 API 文档（60%）
```

**技能响应（更详细一点的简短）：**
```
✅ **上下文已恢复**

📍 位置：Backend-API-v2 - API 文档编写（60%）
📋 待办：完成认证模块文档、添加示例代码

继续？
```

**适用情况：**
- ✅ 移动端快速交互
- ✅ 用户只需要确认状态
- ✅ 上下文非常简单
- ✅ 连续对话中的快速恢复

---

### 场景 4：询问位置（忘记上下文）

**场景描述：** 用户忘记之前讨论的内容，需要快速提醒。

**用户输入：**
```
我们刚才在哪？
之前聊到哪了？
what was I doing?
```

**技能响应：**
```
您之前在讨论 **Backend-API-v2** 项目。

**对话摘要：**
我们完成了用户认证模块的开发，然后开始编写 API 文档。
您说想在今天完成认证模块部分的文档。

**进行中的任务：**
→ 编写 API 文档（完成度 60%）
→ 优先级：高
→ 截止日期：2026-02-10

需要我继续这个任务吗？或者我们换个话题？
```

**适用情况：**
- ✅ 用户忘记讨论内容
- ✅ 中断后回来需要快速回忆
- ✅ 需要确认当前工作重点

---

### 场景 5：多项目上下文恢复

**场景描述：** 用户同时进行多个项目，需要查看所有项目的状态。

**用户输入：**
```
恢复上下文 -完整
```

**技能响应：**
```
✅ **上下文已恢复 - 多项目视图**

═══════════════════════════════════════════════════════════
📊 所有项目概览
═══════════════════════════════════════════════════════════

🔴 高优先级项目（2个）
┌─────────────────────────────────────────────────────────┐
│ 1. 🏛️ Backend-API-v2                                    │
│    状态：🔄 开发中 | 完成度：75% | 截止：2026-02-10      │
│    当前：编写 API 文档（60%）                            │
│    下步：完成认证模块文档                                │
├─────────────────────────────────────────────────────────┤
│ 2. 🔒 安全审计项目                                       │
│    状态：⚠️ 待处理 | 完成度：20% | 截止：2026-02-15     │
│    当前：登录漏洞修复（已完成）                          │
│    下步：完成安全测试                                    │
└─────────────────────────────────────────────────────────┘

🟡 中优先级项目（1个）
┌─────────────────────────────────────────────────────────┐
│ 3. 🌐 Frontend-Dashboard-v3                              │
│    状态：🔄 待测试 | 完成度：90% | 截止：2026-02-20      │
│    当前：UI 组件完成                                     │
│    下步：修复集成测试问题                                │
└─────────────────────────────────────────────────────────┘

🟢 低优先级项目（2个）
┌─────────────────────────────────────────────────────────┐
│ 4. 📱 Mobile-App-v2     | 完成度：10% | 待启动          │
│ 5. 📊 Analytics-v1      | 完成度：5%  | 规划阶段        │
└─────────────────────────────────────────────────────────┘

═══════════════════════════════════════════════════════════
💡 操作建议
═══════════════════════════════════════════════════════════
🔥 紧急：请优先完成 Backend-API-v2 API 文档（截止临近）
⚠️ 注意：安全审计项目有新发现待处理

请输入项目编号继续：
1 → Backend-API-v2
2 → 安全审计
3 → Frontend-Dashboard
4 → Mobile-App
5 → Analytics
```

**适用情况：**
- ✅ 同时管理多个项目
- ✅ 需要项目概览而非单个任务
- ✅ 项目优先级决策

---

## 响应格式详解

### Minimal 级别

**触发方式：**
- 用户输入包含 `-简短` 或 `-minimal`
- 用户输入仅为 `接着`、`continue`（简短模式）

**输出格式：**
```
✅ [状态摘要] → [任务名称]（[完成度]）
```

**输出示例：**
```
✅ 已恢复 → 编写 API 文档（60%）
✅ 继续 Backend-API-v2 开发（75%）
✅ Hermès 数据处理模块（进行中）
```

**适用场景：**
- 移动设备快速交互
- 用户只需要确认状态
- 上下文非常简单
- 语音交互场景

---

### Normal 级别（默认）

**触发方式：**
- 用户输入 `恢复上下文` 或 `restore context`
- 无特殊参数

**输出格式：**
```
✅ **上下文已恢复**

📋 当前任务
- 任务：[任务名]
- 优先级：[优先级]
- 状态：[状态]

🔧 核心项目
- 项目名：[项目名]
- 状态：[状态]
- 完成度：[百分比]

📝 最近操作记录
1. [操作1]（[时间]）
2. [操作2]（[时间]）
...

💡 建议操作
→ [建议1]
→ [建议2]

[等待用户输入]
```

**输出示例：**
```
✅ **上下文已恢复**

📋 当前任务
- 任务：编写 API 文档
- 优先级：高
- 状态：进行中（60%）

🔧 核心项目
- 项目名：Backend-API-v2
- 状态：开发中
- 完成度：75%

📝 最近操作记录
1. 完成用户认证模块（2小时前）
2. 修复登录漏洞（5小时前）
3. 编写单元测试（昨天）

💡 建议操作
→ 继续编写 API 端点文档
→ 先完成用户认证模块测试
→ 讨论下一个功能需求

您想继续哪个任务？
```

**适用场景：**
- ✅ 默认模式，推荐使用
- 大多数恢复场景
- 日常工作恢复
- 需要项目+任务信息

---

### Detailed 级别

**触发方式：**
- 用户输入包含 `-完整`、`-detailed`、`-详细`

**输出格式：**
```
✅ **上下文已恢复 - 详细模式**

═══════════════════════════════════════════════════════════
📅 会话信息
═══════════════════════════════════════════════════════════
- [字段1]: [值]
- [字段2]: [值]
...

═══════════════════════════════════════════════════════════
📋 当前任务详情
═══════════════════════════════════════════════════════════
- [详细字段...]
...

═══════════════════════════════════════════════════════════
🔧 核心项目状态
═══════════════════════════════════════════════════════════
[每个项目的详细状态]

═══════════════════════════════════════════════════════════
📝 MEMORY.md 要点
═══════════════════════════════════════════════════════════
[个人偏好、设置、注意事项]

═══════════════════════════════════════════════════════════
🕐 完整时间线
═══════════════════════════════════════════════════════════
[按时间排序的事件列表]

═══════════════════════════════════════════════════════════
💡 建议操作
═══════════════════════════════════════════════════════════
[优先级排序的操作建议]

═══════════════════════════════════════════════════════════
🎯 下一步行动
═══════════════════════════════════════════════════════════
[具体操作选项]
```

**输出示例：** 详见[场景 2](#场景-2-长时间中断后恢复)

**适用场景：**
- ✅ 长时间离开后的完整恢复
- ✅ 需要完整历史记录
- ✅ 项目交接或回顾
- ✅ 重要决策前需要完整上下文

---

## CLI 使用方法

### 基本命令

```bash
# 正常级别（默认）
python scripts/restore_context.py normal

# 简短级别
python scripts/restore_context.py minimal

# 详细级别
python scripts/restore_context.py detailed
```

### 高级用法

```bash
# 指定上下文文件路径
python scripts/restore_context.py normal --context ./custom_context.json

# 静默模式（无交互）
python scripts/restore_context.py minimal --quiet

# 仅输出 JSON 格式
python scripts/restore_context.py detailed --json

# 强制刷新缓存
python scripts/restore_context.py normal --force-refresh
```

### 脚本参数说明

| 参数 | 说明 |
|------|------|
| `normal/minimal/detailed` | 恢复级别 |
| `--context <path>` | 指定上下文文件路径 |
| `--quiet` | 静默模式，减少输出 |
| `--json` | 输出 JSON 格式而非 Markdown |
| `--force-refresh` | 强制刷新缓存 |
| `--help` | 显示帮助信息 |

---

## JSON 数据格式

### 输入格式（compressed_context/latest_compressed.json）

```json
{
  "session_info": {
    "session_id": "agent:main:main",
    "session_type": "main",
    "started_at": "2026-02-05T10:00:00Z",
    "last_active": "2026-02-06T23:30:00Z",
    "duration_hours": 37.5
  },
  "recent_actions": [
    {
      "description": "完成用户认证模块",
      "timestamp": "2026-02-06T21:00:00Z",
      "category": "development",
      "project": "Backend-API-v2"
    },
    {
      "description": "修复登录漏洞 CVE-2026-001",
      "timestamp": "2026-02-06T18:00:00Z",
      "category": "bugfix",
      "project": "Backend-API-v2"
    },
    {
      "description": "编写单元测试",
      "timestamp": "2026-02-05T16:00:00Z",
      "category": "testing",
      "project": "Backend-API-v2"
    }
  ],
  "core_projects": [
    {
      "name": "Backend-API-v2",
      "status": "active",
      "priority": "high",
      "completion": 75,
      "description": "REST API 后端服务 v2",
      "subtasks": [
        {
          "name": "用户认证模块",
          "status": "completed",
          "completion": 100
        },
        {
          "name": "API 文档编写",
          "status": "in_progress",
          "completion": 60
        },
        {
          "name": "数据查询模块",
          "status": "pending",
          "completion": 40
        }
      ]
    }
  ],
  "current_tasks": [
    {
      "description": "编写 API 文档",
      "priority": "high",
      "status": "in_progress",
      "completion": 60,
      "deadline": "2026-02-10",
      "project": "Backend-API-v2",
      "estimated_hours": 4
    }
  ],
  "memory_highlights": [
    "用户偏好：详细的技术文档",
    "工作习惯：每天早上 9:00 开始工作",
    "技术栈：Python > Node.js"
  ],
  "compressed_at": "2026-02-06T23:30:00.000Z"
}
```

### 字段说明

| 字段 | 类型 | 说明 |
|------|------|------|
| `session_info` | object | 会话基本信息 |
| `recent_actions` | array | 最近操作列表（最多10条） |
| `core_projects` | array | 核心项目列表 |
| `current_tasks` | array | 当前任务列表 |
| `memory_highlights` | array | MEMORY.md 要点摘要 |
| `compressed_at` | string | 压缩时间戳 |

---

## 与其他技能的集成

### 集成 1：与 memory_get 配合

**场景：** 用户需要恢复会话上下文，同时想查看个人记忆和偏好设置。

**工作流程：**
```
1. context-restore 恢复会话上下文
2. memory_get 读取 MEMORY.md 完整内容
3. 合并输出完整的用户上下文
```

**用户输入：**
```
恢复上下文，查看我的偏好设置
```

**技能响应：**
```
✅ **上下文已恢复**

═══════════════════════════════════════════════════════════
📋 会话上下文
═══════════════════════════════════════════════════════════
**当前任务：** 编写 API 文档（60%）
**项目状态：** Backend-API-v2（开发中，75%）
**最近操作：** 完成用户认证模块

═══════════════════════════════════════════════════════════
👤 个人偏好设置（来自 memory_get）
═══════════════════════════════════════════════════════════
**文档偏好：**
- 格式：Markdown + 代码示例
- 详细程度：详细（完整参数说明）
- 语言：中文（技术术语可保留英文）

**工作习惯：**
- 工作时间：09:00 - 18:00 UTC
- 每日优先：处理高优先级任务
- 沟通风格：简洁，直接给出选项

**技术栈：**
- 主要语言：Python
- 框架：Django, FastAPI
- 数据库：PostgreSQL, Redis

**当前目标：**
- 本周完成 Backend-API-v2 API 文档
- 下周开始安全审计

═══════════════════════════════════════════════════════════
💡 建议操作
═══════════════════════════════════════════════════════════
1. 继续编写 API 文档（符合您的偏好设置）
2. 查看 Backend-API 项目详情
3. 讨论新功能需求

请告诉我您想怎么做？
```

**实现代码：**
```python
async def restore_with_memory():
    # 1. 恢复会话上下文
    session_context = await context_restore.run(level="normal")
    
    # 2. 获取个人记忆
    memory = await memory_get.run(query="偏好设置 工作习惯 技术栈")
    
    # 3. 合并输出
    return merge_contexts(session_context, memory)
```

**使用场景：**
- ✅ 新会话开始时全面了解用户
- ✅ 重要决策前回顾用户偏好
- ✅ 个性化回复需要

---

### 集成 2：与 sessions_spawn 配合

**场景：** 恢复上下文后，需要在独立会话中执行长时间运行的任务。

**用户输入：**
```
恢复上下文，然后在后台编译项目
```

**技能响应：**
```
✅ **上下文已恢复**

**当前状态：**
- Backend-API-v2 - API 文档编写（60%）
- 最近操作：完成用户认证模块

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🚀 **正在创建独立会话进行后台编译...**

✅ **Isolated Session 已创建** (session: build-backend-001)

**会话信息：**
- 类型: isolated（后台运行）
- 任务: 编译 Backend-API-v2 项目
- 预计时间: 5-10 分钟

**会话状态：**
```
[编译中...] ████████████░░░░░░░░░░░ 60%
[单元测试中...] ██████░░░░░░░░░░░░░░ 25%
```

**主会话：** 已解放，您可以继续讨论或执行其他任务。

**后台任务完成时会通知您。**
```

**工作流程图：**
```
用户: "恢复上下文 + 后台编译"
        ↓
context-restore: 恢复当前会话
        ↓
sessions_spawn: 创建 isolated session
        ↓
编译任务在后台运行
        ↓
主会话继续与用户交互
        ↓
编译完成 → 通知用户
```

**使用场景：**
- ✅ 长时间运行编译/测试
- ✅ 并行处理多个任务
- ✅ 资源密集型操作隔离
- ✅ 不阻塞主会话交互

---

### 集成 3：与 cron 配合

**场景 1：定时上下文保存**

**cron 配置：**
```yaml
- name: "定期保存上下文"
  schedule: "0 */2 * * *"  # 每2小时
  command: "save-context"
  description: "自动保存当前上下文"
  on_complete: "context-ready"
  output:
    path: "./compressed_context/auto_save.json"
```

**用户离开时：**
```
✅ **上下文已自动保存**
- 时间: 2026-02-06 22:00
- 任务: 编写 API 文档（55%）
- 项目: Backend-API-v2

我会在后台保持这个状态，随时可以恢复。
```

**场景 2：定时恢复提醒**

**cron 配置：**
```yaml
- name: "工作日开始提醒"
  schedule: "0 9 * * 1-5"  # 工作日 9:00
  command: "notify-resume"
  description: "提醒用户恢复工作上下文"
  context: "latest_compressed.json"
```

**提醒消息：**
```
🌅 **早上好！**

您有未完成的工作：

📋 **待恢复任务：**
- 编写 API 文档（60%）- 高优先级
- 截止日期：2026-02-10

💡 **快速操作：**
- 输入 "继续" → 立即恢复上下文
- 输入 "查看详情" → 查看完整项目状态
- 输入 "新任务" → 开始新工作

祝您今天工作顺利！☕
```

**场景 3：定时任务完成后的上下文恢复**

**工作流程：**
```
定时任务完成
    ↓
自动保存结果到上下文文件
    ↓
通知用户任务完成
    ↓
用户输入 "恢复上下文" → 看到任务结果
```

**示例：**
```
✅ **定时任务完成**

**任务：** 每日代码质量检查
**完成时间：** 2026-02-06 08:00
**结果：** ✅ 通过

**发现问题：**
- ⚠️ 2个警告（未使用变量）
- ℹ️ 1个建议（代码优化）

上下文已保存，输入 "恢复上下文" 查看详情。
```

**使用场景：**
- ✅ 自动保持项目上下文
- ✅ 工作日开始提醒
- ✅ 定时任务结果追踪
- ✅ 意外中断保护

---

### 集成 4：与 context-save 配合

**场景：** 互补使用，context-save 自动保存，context-restore 恢复。

**自动保存触发条件：**
- 用户离开超过 30 分钟
- 任务完成时
- 用户明确要求保存
- 定时触发（每 2 小时）

**用户输入：**
```
保存上下文
```

**技能响应：**
```
✅ **上下文已保存**

**保存内容：**
- 当前任务：编写 API 文档（60%）
- 项目状态：Backend-API-v2（75%）
- 最近操作：完成用户认证模块
- 时间：2026-02-06 23:45:00

**文件位置：** ./compressed_context/latest_compressed.json

随时可以输入 "恢复上下文" 继续工作。
```

**完整工作流：**
```
用户开始工作
    ↓
context-save: 定期自动保存
    ↓
用户离开
    ↓
（自动保存持续进行）
    ↓
用户回来
    ↓
context-restore: 恢复最新上下文
    ↓
用户继续工作
```

---

## 最佳实践

### 何时使用此技能

**✅ 强烈建议使用：**

| 场景 | 示例 | 推荐级别 |
|------|------|---------|
| 长时间离开后回来 | 隔天工作、跨周末 | detailed |
| 设备切换 | 从手机换到电脑 | normal |
| 上下文切换后 | 从会议回来继续开发 | normal |
| 用户明确请求 | "恢复上下文"、"接着之前" | normal |
| 定期工作恢复 | 每天开始工作前 | normal |

**❌ 不建议使用：**

| 场景 | 原因 | 替代方案 |
|------|------|---------|
| 连续对话中 | 上下文中还有 recent actions | 直接继续 |
| 简单任务 | 一两句话完成 | 直接执行 |
| 全新话题 | 不需要历史上下文 | 新建会话 |
| 用户要求新任务 | 用户明确要开始新话题 | 直接开始 |

---

### 与用户沟通的原则

**1. 确认清晰**

```
✅ 正确：明确告诉用户上下文已恢复，并简要总结
❌ 错误：只说"已恢复"，不提供任何信息

✅ "✅ 上下文已恢复。您之前在编写 Backend-API 的 API 文档（60%）。"
```

**2. 提供选择**

```
✅ 正确：列出选项让用户选择
❌ 错误：只问"接下来怎么做？"

✅ "您可以：1. 继续 API 文档；2. 查看项目状态；3. 开始新任务"
```

**3. 适度详细**

```
✅ 正确：根据上下文复杂度调整输出
❌ 错误：总是输出最详细或最简短

- 简单任务 → minimal
- 普通任务 → normal  
- 复杂任务 → detailed
```

**4. 保持友好**

```
✅ 正确：使用鼓励性、友好的语言
❌ 错误：机械、生硬的回复

✅ "欢迎回来！继续您的工作吗？😊"
❌ "上下文已恢复。请输入命令。"
```

---

### 输出格式建议

**Minimal 级别：**
- 一行核心信息
- 不要超过 50 字符
- 使用 emoji 增加可读性

**Normal 级别：**
- 分区块呈现（任务、项目、建议）
- 每区块不超过 5 个要点
- 使用列表提高可扫描性

**Detailed 级别：**
- 使用分隔线划分章节
- 按时间线组织历史
- 提供具体操作选项

---

### 错误处理建议

**场景 1：找不到上下文文件**

```python
try:
    context = load_context()
except FileNotFoundError:
    # 提供友好的错误消息
    return """
❌ 未找到保存的上下文文件

这可能是因为：
1. 还没有保存过上下文
2. 上下文文件已被删除
3. 会话是首次开始

💡 建议：
- 输入 "保存上下文" 先保存当前状态
- 或者直接开始新任务
"""
```

**场景 2：上下文文件损坏**

```python
try:
    context = parse_json()
except JSONDecodeError:
    # 提供恢复选项
    return """
⚠️ 上下文文件可能已损坏

您可以：
1. 使用备份文件恢复
2. 清除当前上下文重新开始
3. 联系技术支持

备份文件位置：./compressed_context/backup_*.json
"""
```

---

## 常见问题解答

### Q1: 上下文恢复需要多长时间？

**答：** 通常在 1-2 秒内完成。具体时间取决于：
- 上下文文件大小（通常 < 100KB）
- 最近操作记录数量（最多 10 条）
- 是否需要读取 MEMORY.md

---

### Q2: 恢复的上下文会不会不完整？

**答：** 完整度取决于保存时的状态。建议：
- 使用 `context-save` 定期自动保存
- 重要操作后手动触发保存
- 设置较高的保存频率（15-30 分钟）

---

### Q3: 可以恢复到特定时间点的上下文吗？

**答：** 当前版本不支持自动时间点恢复。但您可以：
- 手动维护多个上下文备份
- 使用 `backup_latest_compressed.json`
- 未来版本可能增加此功能

---

### Q4: 多个项目同时进行时如何恢复？

**答：** `context-restore` 会自动显示所有核心项目，按优先级排序。您可以：
- 查看完整的多项目视图（detailed 级别）
- 选择特定项目继续
- 使用项目编号快速选择

---

### Q5: 恢复级别如何选择？

**答：** 根据使用场景：

| 级别 | 使用场景 | 用户输入示例 |
|------|---------|-------------|
| Minimal | 移动端、快速确认 | `接着`、`continue -minimal` |
| Normal | 日常工作恢复（推荐） | `恢复上下文` |
| Detailed | 长时间离开、完整恢复 | `恢复上下文 -完整` |

---

### Q6: 上下文文件保存在哪里？

**答：** 默认位置：
- 主要文件：`./compressed_context/latest_compressed.json`
- 备份文件：`./compressed_context/backup_latest_compressed.json`
- 自动保存：`./compressed_context/auto_save.json`

可以配置自定义路径。

---

### Q7: 如何让上下文恢复更智能？

**答：** 可以与 `memory_get` 集成：
- 自动识别用户偏好
- 根据历史选择合适的恢复级别
- 预测用户可能想继续的任务

---

### Q8: 多人协作时如何使用？

**答：** 对于多人协作场景：
- 每个用户有独立的上下文文件
- 使用用户 ID 区分上下文
- 可以合并多个用户的上下文（需要权限）

---

## 故障排除

### 问题 1：技能无响应

**症状：** 用户输入触发词但没有响应

**排查步骤：**
```
1. 检查触发词是否正确
   - 中文：恢复上下文、接着、继续之前的工作
   - 英文：restore context、continue、resume

2. 检查日志
   $ cat logs/context-restore.log

3. 检查上下文文件是否存在
   $ ls -la ./compressed_context/

4. 检查权限
   $ chmod 755 ./compressed_context/
```

**解决方案：**
```bash
# 1. 重新创建上下文目录
mkdir -p ./compressed_context

# 2. 设置正确权限
chmod 755 ./compressed_context

# 3. 初始化空上下文
echo "{}" > ./compressed_context/latest_compressed.json

# 4. 重启服务
openclaw gateway restart
```

---

### 问题 2：JSON 解析错误

**症状：** 报错 "JSONDecodeError" 或 "无法解析上下文文件"

**排查步骤：**
```bash
# 1. 检查文件内容
cat ./compressed_context/latest_compressed.json

# 2. 验证 JSON 格式
python -m json.tool ./compressed_context/latest_compressed.json

# 3. 查看错误行号
python -c "import json; json.load(open('./compressed_context/latest_compressed.json'))"
```

**解决方案：**
```bash
# 方案 1：使用备份恢复
cp ./compressed_context/backup_latest_compressed.json ./compressed_context/latest_compressed.json

# 方案 2：清空并重新开始
echo "{}" > ./compressed_context/latest_compressed.json

# 方案 3：手动修复（编辑文件）
nano ./compressed_context/latest_compressed.json
```

**预防措施：**
- 启用自动备份（每次保存前备份）
- 定期验证 JSON 完整性
- 使用版本控制追踪变化

---

### 问题 3：恢复内容不准确

**症状：** 恢复的信息与实际不符

**排查步骤：**
```
1. 检查最近保存时间
   $ cat ./compressed_context/latest_compressed.json | grep compressed_at

2. 检查 recent_actions 是否最新
   $ cat ./compressed_context/latest_compressed.json | grep recent_actions

3. 查看是否有多个上下文文件
   $ ls -la ./compressed_context/
```

**解决方案：**
```bash
# 1. 手动保存最新上下文
python scripts/save_context.py --force

# 2. 检查保存脚本是否正常运行
python scripts/save_context.py --dry-run

# 3. 验证保存逻辑
python -c "from context_save import save; save()"
```

---

### 问题 4：输出格式混乱

**症状：** 恢复报告格式不正确，emoji 或特殊字符显示异常

**排查步骤：**
```
1. 检查终端编码设置
   $ echo $LANG
   $ echo $LC_ALL

2. 检查文件编码
   $ file ./compressed_context/latest_compressed.json

3. 查看原始输出
   $ python scripts/restore_context.py normal --raw
```

**解决方案：**
```bash
# 1. 设置 UTF-8 编码
export LANG=en_US.UTF-8
export LC_ALL=en_US.UTF-8

# 2. 或使用 ASCII 模式
python scripts/restore_context.py normal --ascii

# 3. 检查终端支持
$ curl https://raw.githubusercontent.com/srstenson/unicode-emoji-check/master/test.sh | bash
```

---

### 问题 5：与其他技能冲突

**症状：** 多个技能同时响应，或 context-restore 被其他技能覆盖

**排查步骤：**
```
1. 检查技能优先级
   $ openclaw skills list --priority

2. 查看触发日志
   $ cat logs/context-restore.log | grep "triggered"

3. 检查关键词冲突
   $ openclaw skills check "继续"
```

**解决方案：**
```yaml
# 1. 在 SKILL.md 中设置优先级
priority: 10  # 较低数字 = 较高优先级

# 2. 添加更精确的触发条件
triggers:
  - "恢复上下文"
  - "接着之前的工作"
  - "restore context"  # 添加英文

# 3. 与其他技能协调
excluded_skills:
  - general_conversation  # 排除通用对话
```

---

## 总结

### 核心要点

1. **触发简单**：用户只需说"恢复上下文"或类似表达
2. **三种级别**：minimal/normal/detailed 满足不同场景
3. **智能恢复